"use strict";function _toConsumableArray(t){if(Array.isArray(t)){for(var a=0,e=Array(t.length);a<t.length;a++)e[a]=t[a];return e}return Array.from(t)}var rpcEndpointList=["https://api.wax.alohaeos.com","https://api.waxsweden.org","https://wax.greymass.com"],wax=new waxjs.WaxJS({rpcEndpoint:"https://api.wax.alohaeos.com",tryAutoLogin:!1});async function autoLogin(){var t;await wax.isAutoLoginAvailable()?(t=wax.userAccount,wax.pubKeys,t=t,document.getElementById("autologin").insertAdjacentHTML("beforeend",t),$("#autologin").addClass("badge"),$("#login").hide(),initSetInterval()):document.getElementById("autologin").insertAdjacentHTML("beforeend","请先手动登录一次并勾选自动登录")}async function login(){try{var t=await wax.login(),a=(wax.pubKeys,t);$("#loginresponse").html(a),console.log("登录成功"),initSetInterval()}catch(t){$("#loginresponse").html(t.message)}}async function sign(t){if(!wax.api)return alert("请先登录");try{await wax.api.transact({actions:t},{blocksBehind:3,expireSeconds:30});farm.taskList.length&&farm.reqTask()}catch(t){$("#loginresponse").html(t.message),farm.taskList.length&&farm.reqTask()}}async function first_sign(){if(!wax.api)return alert("请先登录");try{await wax.api.transact({actions:[{account:"farmersworld",name:"recover",authorization:[{actor:wax.userAccount,permission:"active"}],data:{owner:wax.userAccount,energy_recovered:1}}]},{blocksBehind:3,expireSeconds:30});$("#first_sign").hide()}catch(t){$("#loginresponse").html(t.message)}}autoLogin();var farm={toolList:[],taskList:[],animalsTpl:[298599,298607],barleyTplId:260676,getTools:function(){var e=this;$.ajax({contentType:"application/json; charset=utf-8",dataType:"json",type:"POST",url:"https://api.wax.alohaeos.com/v1/chain/get_table_rows",data:JSON.stringify({json:!0,code:"farmersworld",scope:"farmersworld",table:"tools",lower_bound:wax.userAccount,upper_bound:wax.userAccount,index_position:2,key_type:"i64",limit:"100",reverse:!1,show_payer:!1}),success:function(t){e.toolList=[].concat(_toConsumableArray(e.toolList),_toConsumableArray(t.rows)),$("#tools").html(JSON.stringify(e.toolList));var a=parseInt((new Date).getTime()/1e3);e.toolList.map(async function(t){t.current_durability<20&&(console.warn(t.asset_id,"可以修复"),e.taskList.push({type:"repair",asset_id:t.asset_id})),a>=t.next_availability&&(console.warn(t.asset_id,"可以mine"),e.taskList.push({type:"claim",asset_id:t.asset_id}))}),e.taskList.length?($("#jobs").html(JSON.stringify(e.taskList)),e.reqTask()):$("#jobs").html("暂无任务")}})},getCrops:function(){var e=this;$.ajax({contentType:"application/json; charset=utf-8",dataType:"json",type:"POST",url:"https://api.wax.alohaeos.com/v1/chain/get_table_rows",data:JSON.stringify({json:!0,code:"farmersworld",scope:"farmersworld",table:"crops",lower_bound:wax.userAccount,upper_bound:wax.userAccount,index_position:2,key_type:"i64",limit:"100",reverse:!1,show_payer:!1}),success:function(t){e.toolList=[].concat(_toConsumableArray(e.toolList),_toConsumableArray(t.rows)),$("#tools").html(JSON.stringify(e.toolList));var a=parseInt((new Date).getTime()/1e3);e.toolList.map(async function(t){a>=t.next_availability&&(console.warn(t.asset_id,"可以mine"),e.taskList.push({type:"cropclaim",asset_id:t.asset_id}))}),e.taskList.length?($("#jobs").html(JSON.stringify(e.taskList)),e.reqTask()):$("#jobs").html("暂无任务")}})},getAnimals:function(){var e=this;$.ajax({contentType:"application/json; charset=utf-8",dataType:"json",type:"POST",url:"https://api.wax.alohaeos.com/v1/chain/get_table_rows",data:JSON.stringify({json:!0,code:"farmersworld",scope:"farmersworld",table:"animals",lower_bound:wax.userAccount,upper_bound:wax.userAccount,index_position:2,key_type:"i64",limit:"100",reverse:!1,show_payer:!1}),success:function(t){t=t.rows.filter(function(t){return e.animalsTpl.includes(t.template_id)});e.toolList=[].concat(_toConsumableArray(e.toolList),_toConsumableArray(t)),$("#tools").html(JSON.stringify(e.toolList));var a=parseInt((new Date).getTime()/1e3);e.toolList.map(async function(t){a>=t.next_availability&&(console.warn(t.asset_id,"可以mine"),e.taskList.push({type:"animals_Barley",asset_id:t.asset_id,use_tpl_id:260676}))}),e.taskList.length?($("#jobs").html(JSON.stringify(e.taskList)),e.reqTask()):$("#jobs").html("暂无任务")}})},getMbs:function(){var e=this;$.ajax({contentType:"application/json; charset=utf-8",dataType:"json",type:"POST",url:"https://api.wax.alohaeos.com/v1/chain/get_table_rows",data:JSON.stringify({json:!0,code:"farmersworld",index_position:2,key_type:"i64",limit:"100",lower_bound:wax.userAccount,reverse:!1,scope:"farmersworld",show_payer:!1,table:"mbs",upper_bound:wax.userAccount}),success:function(t){e.toolList=[].concat(_toConsumableArray(e.toolList),_toConsumableArray(t.rows)),$("#tools").html(JSON.stringify(e.toolList));var a=parseInt((new Date).getTime()/1e3);e.toolList.map(async function(t){a>=t.next_availability&&(console.warn(t.asset_id,"可以mine"),e.taskList.push({type:"mbsclaim",asset_id:t.asset_id}))}),e.taskList.length?e.reqTask():$("#jobs").html("暂无任务")}})},getAccounts:function(t){var e=this;$.ajax({contentType:"application/json; charset=utf-8",dataType:"json",type:"POST",url:"https://api.wax.alohaeos.com/v1/chain/get_table_rows",data:JSON.stringify({code:"farmersworld",index_position:1,json:!0,key_type:"i64",limit:"100",lower_bound:wax.userAccount,reverse:!1,scope:"farmersworld",show_payer:!1,table:"accounts",upper_bound:wax.userAccount}),success:function(t){var a={};t.rows[0].balances.map(function(t){a[t.split(" ")[1]]=t.split(" ")[0]}),$(".resource-balance-amount")[0].innerHTML=a.GOLD,$(".resource-balance-amount")[1].innerHTML=a.WOOD,$(".resource-balance-amount")[2].innerHTML=a.FOOD,$("#energy").html(JSON.stringify(t.rows[0].energy)),$("#max").html(JSON.stringify(t.rows[0].max_energy)),t.rows[0].energy<300&&e.recover(t.rows[0].max_energy-t.rows[0].energy)}})},reqTask:function(){var t=this.taskList[0];"repair"===t.type?this.repair(t.asset_id):"animals_Barley"===t.type?this.getAssets(this.barleyTplId,t.type,t.asset_id):this.mine(t.asset_id,t.type),this.taskList.shift()},mine:async function(t,a,e){var s={owner:wax.userAccount};"animals_Barley"!==a?("cropclaim"===a?s.crop_id=t:s.asset_id=t,sign([{account:"farmersworld",name:a,authorization:[{actor:wax.userAccount,permission:"active"}],data:s}])):sign([{account:"atomicassets",name:"transfer",authorization:[{actor:wax.userAccount,permission:"active"}],data:{asset_ids:[e],from:wax.userAccount,to:"farmersworld",memo:"feed_animal:"+t}}])},repair:async function(t){sign([{account:"farmersworld",name:"repair",authorization:[{actor:wax.userAccount,permission:"active"}],data:{asset_owner:wax.userAccount,asset_id:t}}])},recover:function(t){sign([{account:"farmersworld",name:"recover",authorization:[{actor:wax.userAccount,permission:"active"}],data:{owner:wax.userAccount,energy_recovered:t}}])},getAssets:function(t,a,e){var s=this;$.ajax({contentType:"application/json; charset=utf-8",dataType:"json",type:"GET",url:"https://wax.api.atomicassets.io/atomicassets/v1/assets",data:{collection_name:"farmersworld",page:1,limit:1e3,owner:wax.userAccount,template_blacklist:t},success:function(t){t.data&&t.data.length?s.mine(e,a,t.data[0].asset_id):$("#loginresponse").html("(麦子/玉米)食物不足")}})}};function initSetInterval(){farm.getAccounts(1),setInterval(function(){$("#refreshTime").html("最近执行时间: "+(new Date).toLocaleString()),farm.toolList=Object.assign([]),farm.taskList=Object.assign([]),farm.getAccounts(),farm.getTools(),farm.getMbs(),farm.getCrops(),farm.getAnimals()},18e4)}